<script>
  let pontos = [];

  function adicionarPonto() {
    const lat = document.getElementById('lat').value;
    const lon = document.getElementById('lon').value;
    const alt = document.getElementById('alt').value;

    if (!lat || !lon || !alt) {
      alert("Preencha todos os campos!");
      return;
    }

    const ponto = { lat, lon, alt };
    pontos.push(ponto);
    renderizarPontos();
  }

  function removerPonto(index) {
    pontos.splice(index, 1);
    renderizarPontos();
  }

  function renderizarPontos() {
    const lista = document.getElementById('listaPontos');
    lista.innerHTML = "";

    pontos.forEach((ponto, index) => {
      lista.innerHTML += `
        <div class="ponto">
          <span><strong>Lat:</strong> ${ponto.lat}</span>
          <span><strong>Lon:</strong> ${ponto.lon}</span>
          <span><strong>Alt:</strong> ${ponto.alt}m</span>
          <button class="remover" onclick="removerPonto(${index})">Remover</button>
        </div>
      `;
    });
  }

  async function enviarTodos() {
    const resultado = document.getElementById('resultado');
    resultado.innerHTML = "‚è≥ Enviando todas as localiza√ß√µes...";

    if (pontos.length === 0) {
      resultado.innerHTML = "‚ùå Nenhuma localiza√ß√£o adicionada.";
      return;
    }

    let links = [];

    for (let ponto of pontos) {
      try {
        const res = await fetch("/.netlify/functions/simulador", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ponto)
        });

        const data = await res.json();

        if (data[0] && data[0].kmz) {
          const kmzProxy = `/.netlify/functions/download?url=${encodeURIComponent(data[0].kmz)}`;
          const nomeArquivo = `cobertura_${ponto.lat}_${ponto.lon}.kmz`;

          links.push(`<li><button onclick="baixarKMZ('${kmzProxy}', '${nomeArquivo}')">üì• Baixar KMZ - ${ponto.lat}, ${ponto.lon}</button></li>`);
        } else {
          links.push(`<li>‚ùå Erro na simula√ß√£o para ${ponto.lat}, ${ponto.lon}</li>`);
        }
      } catch (error) {
        links.push(`<li>üî• Erro de requisi√ß√£o para ${ponto.lat}, ${ponto.lon}</li>`);
      }
    }

    resultado.innerHTML = `
      <h3>‚úÖ Simula√ß√µes finalizadas:</h3>
      <ul>${links.join("")}</ul>
    `;
  }

  async function baixarKMZ(url, nome) {
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = nome;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    } catch (err) {
      alert("‚ùå Erro ao baixar o KMZ");
      console.error(err);
    }
  }
</script>
